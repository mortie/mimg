#!/bin/bash

OS=$(uname)

source ~/.mrecrc

if [ "$1" = "" ] && [ ! -f ~/.mrec/name ]; then
	echo "mrec <name>"
	exit 1
elif [ "$1" = "" ]; then #stop recording
	name=$(cat ~/.mrec/name)
	pid=$(cat ~/.mrec/pid)

	URL="d.mort.coffee/vid/${name}.ogv"
	echo $URL | mclip

	kill $pid

	while [ -e "/proc/$pid" ]; do 
		clear
		cat ~/.mrec/log
		sleep 0.1;
	done

	mupload ~/.mrec/rec.ogv "vid/${name}.ogv"

	rm -rf ~/.mrec

	if [ $? -eq 0 ]; then
		mnotify "mrec" "File uploaded to $URL"
	else
		merror "mrec" "Couldn't upload recording."
		echo "An error occurred." 1>&2
		exit 1
	fi
else #start recording
	rm -rf ~/.mrec
	mkdir ~/.mrec
	sleep 0.2
	echo "$1" > ~/.mrec/name

	recordmydesktop -x $X -y $Y --width $W --height $H -o ~/.mrec/rec.ogv > ~/.mrec/log 2>&1 &
	echo $! > ~/.mrec/pid
fi
